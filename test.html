<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame AR Plane Detection Example</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

   <!-- 網頁用Console -->
  <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.0/vconsole.min.js"></script>
  <script>  var vConsole = new VConsole();  </script>
  </head>
  <body style="margin:0; overflow:hidden;">
    <!-- UI 層 (dom-overlay 用) -->
    <div id="overlay" style="position: absolute; top: 10px; left: 10px; color: white; z-index: 999;">
      <button id="placeBtn" style="padding: 10px; font-size: 16px;">放置物件</button>
    </div>

    <!-- A-Frame 場景 -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      webxr="optionalFeatures: hit-test"
      renderer="colorManagement: true"
      ar-hit-test>
      
      <!-- 會被放到平面的物件 (預設隱藏) -->
      <a-box id="placedBox" color="tomato" depth="0.2" height="0.2" width="0.2" visible="false"></a-box>
      
      <a-camera></a-camera>
    </a-scene>

    <script>
      AFRAME.registerComponent("ar-hit-test", {
        init: function () {
          const sceneEl = this.el;
          const box = document.getElementById("placedBox");
          const placeBtn = document.getElementById("placeBtn");

          let hitTestSource = null;
          let localSpace = null;
          let placed = false;

          sceneEl.renderer.xr.addEventListener("sessionstart", async () => {
            const session = sceneEl.renderer.xr.getSession();

            // 請求 hit-test source
            const viewerSpace = await session.requestReferenceSpace("viewer");
            hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
            localSpace = await session.requestReferenceSpace("local");

            session.addEventListener("end", () => {
              hitTestSource = null;
              localSpace = null;
            });
          });

          sceneEl.renderer.xr.addEventListener("sessionend", () => {
            placed = false;
            box.setAttribute("visible", false);
          });

          this.el.sceneEl.renderer.setAnimationLoop((timestamp, frame) => {
            if (!frame || !hitTestSource || placed) return;

            const referenceSpace = localSpace;
            const hitTestResults = frame.getHitTestResults(hitTestSource);

            if (hitTestResults.length > 0) {
              const pose = hitTestResults[0].getPose(referenceSpace);

              // 把方塊移到偵測到的位置
              box.object3D.position.set(
                pose.transform.position.x,
                pose.transform.position.y,
                pose.transform.position.z
              );
              box.setAttribute("visible", true);
            }
          });

          // 點擊按鈕 → 固定物件
          placeBtn.addEventListener("click", () => {
            if (box.getAttribute("visible")) {
              placed = true;
            }
          });
        }
      });
    </script>
  </body>
</html>
