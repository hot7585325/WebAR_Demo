<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Compatible WebXR AR Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  </head>
  <body style="margin:0; padding:0; overflow:hidden; background:#000;">
    <div id="ui" style="position: absolute; top: 20px; left: 20px; right: 20px; z-index: 999;">
      <button id="startAR" style="width: 100%; padding: 20px; font-size: 20px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer;">
        啟動 AR
      </button>
      
      <div id="status" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.8); color: white; border-radius: 10px; font-family: Arial, sans-serif; font-size: 14px;">
        準備測試 AR...
      </div>
      
      <div id="debug" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.6); color: #ccc; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
        <div>除錯資訊:</div>
      </div>
    </div>

    <script>
      const startBtn = document.getElementById('startAR');
      const status = document.getElementById('status');
      const debug = document.getElementById('debug');
      
      let scene, camera, renderer, cube;
      let xrSession = null;
      let animationId = null;
      
      function updateStatus(msg) {
        status.textContent = msg;
        addDebug('Status: ' + msg);
      }
      
      function addDebug(msg) {
        const div = document.createElement('div');
        div.textContent = new Date().toLocaleTimeString() + ': ' + msg;
        debug.appendChild(div);
        debug.scrollTop = debug.scrollHeight;
        console.log('[AR Debug]', msg);
        
        // 限制除錯訊息數量
        if (debug.children.length > 20) {
          debug.removeChild(debug.children[1]); // 保留標題
        }
      }
      
      function initThreeJS() {
        addDebug('初始化 Three.js...');
        
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        renderer = new THREE.WebGLRenderer({ 
          alpha: true,
          antialias: true 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // 創建一個簡單的立方體
        const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
        const material = new THREE.MeshBasicMaterial({ 
          color: 0xff0000,
          wireframe: false
        });
        cube = new THREE.Mesh(geometry, material);
        cube.position.set(0, 0, -0.5); // 放置在相機前方50cm
        scene.add(cube);
        
        addDebug('Three.js 初始化完成');
        updateStatus('準備就緒，點擊啟動 AR');
      }
      
      async function checkARSupport() {
        addDebug('檢查 WebXR 支援...');
        
        if (!navigator.xr) {
          throw new Error('瀏覽器不支援 WebXR');
        }
        
        addDebug('WebXR API 可用');
        
        const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
        addDebug(`AR 支援檢查結果: ${arSupported}`);
        
        if (!arSupported) {
          throw new Error('設備不支援 immersive-ar');
        }
        
        return true;
      }
      
      async function startAR() {
        try {
          updateStatus('正在檢查 AR 支援...');
          startBtn.disabled = true;
          
          await checkARSupport();
          
          updateStatus('請求 AR 會話...');
          addDebug('請求基本的 immersive-ar 會話...');
          
          // 使用最基本的會話配置
          xrSession = await navigator.xr.requestSession('immersive-ar', {
            optionalFeatures: [] // 不要求任何特殊功能
          });
          
          addDebug('AR 會話創建成功');
          updateStatus('設置渲染器...');
          
          // 設置 WebXR 會話到 Three.js
          await renderer.xr.setSession(xrSession);
          addDebug('渲染器設置完成');
          
          // 會話結束監聽
          xrSession.addEventListener('end', onSessionEnd);
          
          // 直接開始渲染循環，不使用參考空間
          updateStatus('開始 AR 渲染...');
          addDebug('啟動渲染循環（無參考空間模式）');
          
          renderer.setAnimationLoop(render);
          
          updateStatus('AR 啟動成功！你應該能看到一個紅色方塊');
          addDebug('AR 基本模式運行中');
          
          // 3秒後隱藏 UI
          setTimeout(() => {
            if (xrSession) {
              document.getElementById('ui').style.display = 'none';
            }
          }, 5000);
          
        } catch (error) {
          updateStatus('AR 啟動失敗: ' + error.message);
          addDebug('錯誤詳情: ' + error.name + ' - ' + error.message);
          startBtn.disabled = false;
          
          // 顯示一些幫助資訊
          setTimeout(() => {
            addDebug('可能的解決方案:');
            addDebug('1. 確保使用 Chrome 79+');
            addDebug('2. 確保 ARCore 已安裝');
            addDebug('3. 確保通過 HTTPS 訪問');
            addDebug('4. 嘗試重啟瀏覽器');
          }, 1000);
        }
      }
      
      function onSessionEnd() {
        addDebug('AR 會話結束');
        updateStatus('AR 會話已結束');
        
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        
        xrSession = null;
        startBtn.disabled = false;
        startBtn.textContent = '重新啟動 AR';
        document.getElementById('ui').style.display = 'block';
      }
      
      function render(timestamp, frame) {
        // 簡單動畫
        if (cube) {
          cube.rotation.x += 0.005;
          cube.rotation.y += 0.01;
        }
        
        renderer.render(scene, camera);
      }
      
      // 事件監聽
      startBtn.addEventListener('click', startAR);
      
      // 初始化
      window.addEventListener('load', () => {
        addDebug('頁面載入完成');
        addDebug('User Agent: ' + navigator.userAgent.substring(0, 100) + '...');
        addDebug('Protocol: ' + window.location.protocol);
        initThreeJS();
      });
      
      // 處理視窗調整
      window.addEventListener('resize', () => {
        if (camera && renderer) {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }
      });
      
      // 全域錯誤處理
      window.addEventListener('error', (e) => {
        addDebug('全域錯誤: ' + e.message);
      });
      
    </script>
  </body>
</html>