<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame AR Plane Detection Example</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

   <!-- 網頁用Console -->
  <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.0/vconsole.min.js"></script>
  <script>  var vConsole = new VConsole();  </script>
  </head>
 <body style="margin:0; overflow:hidden;">
    <!-- UI 層 (dom-overlay 用) -->
    <div id="overlay" style="position: absolute; top: 10px; left: 10px; color: white; z-index: 999; pointer-events: auto;">
      <button id="placeBtn" style="padding: 10px; font-size: 16px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 5px;">放置物件</button>
            <button id="startARBtn" style="padding: 10px; font-size: 16px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 5px;">開啟ar</button>
      <div id="status" style="margin-top: 10px; padding: 5px; background: rgba(0,0,0,0.5); border-radius: 3px;">
        狀態: 初始化中...
      </div>
    </div>

    <!-- A-Frame 場景 -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; overlayElement: #overlay"
      renderer="colorManagement: true; antialias: true"
      background="color: transparent"
      ar-hit-test2>
      
      <!-- 會被放到平面的物件 (預設隱藏) -->
      <a-box 
        id="placedBox" 
        color="tomato" 
        depth="0.2" 
        height="0.2" 
        width="0.2" 
        visible="false"
        shadow="cast: true; receive: false">
      </a-box>
      
      <!-- 添加環境光和方向光 -->
      <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
      <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.6" shadow="cast: true"></a-light>
      
      <a-camera></a-camera>
    </a-scene>

    <script>
      AFRAME.registerComponent("ar-hit-test2", {
        init: function () {
          console.log("AR Hit Test component initialized");
          
          const sceneEl = this.el;
          const box = document.getElementById("placedBox");
          const placeBtn = document.getElementById("placeBtn");
          const startARBtn = document.getElementById("startARBtn");
          const statusDiv = document.getElementById("status");
          const debugDiv = document.getElementById("debug");

          let hitTestSource = null;
          let localSpace = null;
          let placed = false;
          let isSessionActive = false;

          // 更新狀態顯示
          function updateStatus(message) {
            if (statusDiv) {
              statusDiv.textContent = "狀態: " + message;
            }
            console.log("Status:", message);
          }

          // 更新除錯資訊
          function updateDebug(message) {
            if (debugDiv) {
              const timestamp = new Date().toLocaleTimeString();
              debugDiv.innerHTML += `<div>${timestamp}: ${message}</div>`;
              debugDiv.scrollTop = debugDiv.scrollHeight;
            }
            console.log("Debug:", message);
          }

          // 檢查 WebXR 支援
          if (!navigator.xr) {
            updateStatus("WebXR 不支援");
            updateDebug("navigator.xr 不存在");
            return;
          }

          updateDebug("WebXR 可用，檢查 AR 支援...");

          // 詳細的環境檢查
          async function checkEnvironment() {
            try {
              // 檢查 AR 支援
              const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
              updateDebug(`AR 支援: ${arSupported}`);
              
              if (arSupported) {
                updateStatus("AR 支援，點擊按鈕啟動");
                startARBtn.style.display = 'block';
              } else {
                updateStatus("AR 不支援");
                updateDebug("設備或瀏覽器不支援 immersive-ar");
              }

              // 檢查用戶代理
              updateDebug(`User Agent: ${navigator.userAgent}`);
              
              // 檢查是否為 HTTPS
              updateDebug(`Protocol: ${window.location.protocol}`);
              if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                updateDebug("警告: 不是 HTTPS，AR 可能無法正常運作");
              }

            } catch (error) {
              updateStatus("檢查環境時發生錯誤");
              updateDebug(`環境檢查錯誤: ${error.message}`);
            }
          }

          checkEnvironment();

          // 手動啟動 AR
          startARBtn.addEventListener('click', async () => {
            updateDebug("用戶點擊啟動 AR 按鈕");
            
            try {
              updateStatus("正在啟動 AR...");
              startARBtn.disabled = true;
              startARBtn.textContent = "啟動中...";

              // 嘗試直接啟動 AR 會話
              if (navigator.xr) {
                updateDebug("嘗試請求 AR 會話...");
                
                const session = await navigator.xr.requestSession('immersive-ar', {
                  requiredFeatures: ['hit-test'],
                  optionalFeatures: ['dom-overlay'],
                  domOverlay: { root: document.getElementById('overlay') }
                });
                
                updateDebug("AR 會話請求成功");
                
                // 設定會話到 A-Frame
                sceneEl.renderer.xr.setSession(session);
                
                updateStatus("正在初始化...");
                
              } else {
                throw new Error("WebXR 不可用");
              }
              
            } catch (error) {
              updateStatus("啟動 AR 失敗");
              updateDebug(`AR 啟動錯誤: ${error.name} - ${error.message}`);
              startARBtn.disabled = false;
              startARBtn.textContent = "重試啟動 AR";
              
              // 嘗試降級方案
              updateDebug("嘗試使用 A-Frame 內建方式啟動...");
              try {
                sceneEl.enterVR();
              } catch (fallbackError) {
                updateDebug(`降級方案也失敗: ${fallbackError.message}`);
              }
            }
          });

          // Session 開始事件
          sceneEl.renderer.xr.addEventListener("sessionstart", async () => {
            console.log("XR Session started");
            updateStatus("AR 會話已啟動");
            updateDebug("XR 會話開始事件觸發");
            isSessionActive = true;
            
            startARBtn.style.display = 'none';
            placeBtn.style.display = 'block';
            
            try {
              const session = sceneEl.renderer.xr.getSession();
              updateDebug(`會話特性: ${JSON.stringify([...session.enabledFeatures])}`);

              // 請求參考空間
              updateDebug("請求參考空間...");
              const viewerSpace = await session.requestReferenceSpace("viewer");
              localSpace = await session.requestReferenceSpace("local");
              updateDebug("參考空間獲取成功");
              
              // 請求 hit-test source
              updateDebug("請求 hit-test source...");
              hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
              updateDebug("Hit-test source 創建成功");
              
              updateStatus("平面偵測已啟用");

              // Session 結束處理
              session.addEventListener("end", () => {
                console.log("XR Session ended");
                hitTestSource = null;
                localSpace = null;
                isSessionActive = false;
                placed = false;
                box.setAttribute("visible", false);
                updateStatus("AR 會話已結束");
                updateDebug("AR 會話結束");
                startARBtn.style.display = 'block';
                startARBtn.disabled = false;
                startARBtn.textContent = "啟動 AR";
                placeBtn.style.display = 'none';
              });

            } catch (error) {
              console.error("Error setting up hit test:", error);
              updateStatus("設置平面偵測時發生錯誤");
              updateDebug(`設置錯誤: ${error.message}`);
            }
          });

          // 渲染循環
          this.el.sceneEl.renderer.setAnimationLoop((timestamp, frame) => {
            if (!frame || !hitTestSource || !localSpace || !isSessionActive) {
              return;
            }

            try {
              const hitTestResults = frame.getHitTestResults(hitTestSource);

              if (hitTestResults.length > 0 && !placed) {
                const pose = hitTestResults[0].getPose(localSpace);
                
                if (pose) {
                  // 把方塊移到偵測到的位置
                  const position = pose.transform.position;
                  const quaternion = pose.transform.orientation;
                  
                  box.object3D.position.set(position.x, position.y, position.z);
                  box.object3D.quaternion.set(quaternion.x, quaternion.y, quaternion.z, quaternion.w);
                  
                  if (!box.getAttribute("visible")) {
                    box.setAttribute("visible", true);
                    updateStatus("偵測到平面，點擊按鈕放置物件");
                  }
                }
              }
            } catch (error) {
              console.error("Hit test error:", error);
              updateDebug(`Hit test 錯誤: ${error.message}`);
            }
          });

          // 點擊按鈕 → 固定物件
          placeBtn.addEventListener("click", () => {
            console.log("Place button clicked");
            if (box.getAttribute("visible") && isSessionActive) {
              placed = true;
              updateStatus("物件已放置");
              updateDebug(`物件放置於: ${JSON.stringify(box.object3D.position)}`);
            } else {
              updateStatus("無法放置物件 - 未偵測到平面");
              updateDebug("放置失敗 - 物件不可見或會話未活躍");
            }
          });

          // A-Frame 事件監聽
          sceneEl.addEventListener('enter-vr', () => {
            console.log('Entering VR/AR mode');
            updateDebug('A-Frame enter-vr 事件');
          });

          sceneEl.addEventListener('exit-vr', () => {
            console.log('Exiting VR/AR mode');
            updateDebug('A-Frame exit-vr 事件');
          });
        }
      });
    </script>
  </body>
</html>
