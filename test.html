
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <title>A-Frame WebXR 平面偵測 Demo</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  </head>
  <body style="margin:0; overflow:hidden;">
    <!-- A-Frame 場景 -->
    <a-scene
      renderer="colorManagement: true; physicallyCorrectLights: true;"
      xr-mode-ui="enabled: true"
      webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; domOverlay: {root: #overlay}"
      ar-hit-test2
      embedded
      vr-mode-ui="enabled: false">
      
      <!-- 光源 -->
      <a-entity light="type: directional; intensity: 0.8" position="1 1 1"></a-entity>
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>

      <!-- 平面偵測游標 -->
      <a-entity id="cursor"
                geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                material="color: yellow; shader: flat"
                position="0 0 -1"
                visible="false">
      </a-entity>

      <!-- 測試用 3D 物件（可改成自己的 glTF 模型） -->
      <a-box id="object"
             position="0 0 -1"
             material="color: red"
             depth="0.2" height="0.2" width="0.2"
             visible="false">
      </a-box>
    </a-scene>

    <!-- 疊加的 DOM UI -->
    <div id="overlay" style="position: absolute; top: 20px; left: 20px; z-index: 999;">
      <button id="placeBtn" style="padding: 10px 20px; font-size: 16px;">放置物件</button>
    </div>

    <script>
      // === A-Frame 自訂元件：平面偵測 hit-test ===
      AFRAME.registerComponent('ar-hit-test2', {
        init: function () {
          const sceneEl = this.el.sceneEl;
          const renderer = sceneEl.renderer;
          renderer.xr.enabled = true;

          let hitTestSource = null;
          let localSpace = null;

          sceneEl.renderer.xr.addEventListener('sessionstart', async () => {
            const session = renderer.xr.getSession();
            const viewerSpace = await session.requestReferenceSpace('viewer');
            hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
            localSpace = await session.requestReferenceSpace('local');
          });

          this.el.sceneEl.renderer.setAnimationLoop((timestamp, frame) => {
            if (!frame || !hitTestSource) return;

            const referenceSpace = localSpace;
            const hitTestResults = frame.getHitTestResults(hitTestSource);

            if (hitTestResults.length > 0) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(referenceSpace);

              // 更新 cursor 的位置
              const cursor = document.querySelector('#cursor');
              cursor.object3D.position.set(
                pose.transform.position.x,
                pose.transform.position.y,
                pose.transform.position.z
              );
              cursor.setAttribute('visible', true);
            }
          });
        }
      });

      // === 綁定按鈕事件：將物件放到偵測到的平面上 ===
      document.querySelector('#placeBtn').addEventListener('click', () => {
        const cursor = document.querySelector('#cursor');
        const obj = document.querySelector('#object');
        obj.object3D.position.copy(cursor.object3D.position);
        obj.setAttribute('visible', true);
      });
    </script>
  </body>
</html>
