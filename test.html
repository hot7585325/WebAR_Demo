<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pure WebXR AR Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 只載入 Three.js，不使用 A-Frame -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  </head>
  <body style="margin:0; padding:0; overflow:hidden; background:#000;">
    <div id="ui" style="position: absolute; top: 20px; left: 20px; right: 20px; z-index: 999;">
      <button id="startAR" style="width: 100%; padding: 20px; font-size: 20px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer;">
        啟動 AR
      </button>
      
      <div id="status" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.8); color: white; border-radius: 10px; font-family: Arial, sans-serif;">
        等待啟動 AR...
      </div>
    </div>

    <script>
      console.log('純 WebXR AR 測試開始');
      
      const startBtn = document.getElementById('startAR');
      const status = document.getElementById('status');
      
      let scene, camera, renderer, cube;
      let xrSession = null;
      let xrRefSpace = null;
      
      function updateStatus(msg) {
        status.textContent = msg;
        console.log('[AR Status]', msg);
      }
      
      function initThreeJS() {
        console.log('初始化 Three.js...');
        
        // 創建場景
        scene = new THREE.Scene();
        
        // 創建相機
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        // 創建渲染器
        renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // 創建一個紅色立方體
        const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        cube = new THREE.Mesh(geometry, material);
        cube.position.set(0, 0, -1);
        scene.add(cube);
        
        // 添加一些光源
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);
        
        console.log('Three.js 初始化完成');
        updateStatus('Three.js 準備就緒，點擊啟動 AR');
      }
      
      async function startAR() {
        try {
          updateStatus('檢查 WebXR 支援...');
          
          if (!navigator.xr) {
            throw new Error('瀏覽器不支援 WebXR');
          }
          
          const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
          if (!arSupported) {
            throw new Error('設備不支援 AR');
          }
          
          updateStatus('請求 AR 會話...');
          startBtn.disabled = true;
          
          // 請求最簡單的 AR 會話
          xrSession = await navigator.xr.requestSession('immersive-ar');
          
          updateStatus('AR 會話創建成功，初始化...');
          
          // 設置渲染器
          await renderer.xr.setSession(xrSession);
          
          // 請求參考空間
          try {
            xrRefSpace = await xrSession.requestReferenceSpace('local');
            updateStatus('使用 local 參考空間');
          } catch (e) {
            try {
              xrRefSpace = await xrSession.requestReferenceSpace('viewer');
              updateStatus('使用 viewer 參考空間');
            } catch (e2) {
              throw new Error('無法獲取任何參考空間');
            }
          }
          
          // 會話結束處理
          xrSession.addEventListener('end', () => {
            updateStatus('AR 會話結束');
            startBtn.disabled = false;
            startBtn.textContent = '重新啟動 AR';
            document.getElementById('ui').style.display = 'block';
          });
          
          // 開始渲染
          renderer.setAnimationLoop(render);
          
          updateStatus('AR 啟動成功！應該可以看到紅色立方體');
          
          // 隱藏 UI
          setTimeout(() => {
            document.getElementById('ui').style.display = 'none';
          }, 3000);
          
        } catch (error) {
          updateStatus('AR 啟動失敗: ' + error.message);
          startBtn.disabled = false;
          console.error('AR Error:', error);
        }
      }
      
      function render(timestamp, frame) {
        // 簡單的動畫 - 讓立方體旋轉
        if (cube) {
          cube.rotation.x += 0.01;
          cube.rotation.y += 0.01;
        }
        
        renderer.render(scene, camera);
      }
      
      // 事件監聽
      startBtn.addEventListener('click', startAR);
      
      // 初始化
      window.addEventListener('load', () => {
        console.log('頁面載入完成');
        initThreeJS();
      });
      
      // 視窗調整
      window.addEventListener('resize', () => {
        if (camera && renderer) {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }
      });
    </script>
  </body>
</html>