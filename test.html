<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebXR 平面偵測與模型放置</title>
  <meta name="description" content="A-Frame WebXR Plane Detection Example">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    /* 用於顯示 Log 的 DOM 元素樣式 */
    #dom-log {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 150px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-family: monospace;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: scroll;
      font-size: 12px;
      z-index: 10000;
    }
    .ar-button {
        position: fixed;
        bottom: 160px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10001;
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="dom-log">DOM Log Initialized...<br></div>
  <button id="ar-button" class="ar-button" style="display: none;">Enter AR</button>

  <a-scene 
    webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #dom-log"
    ar-hit-test="target: #reticle;"
    renderer="antialias: true; colorManagement: true;">

    <a-assets>
      <a-asset-item id="model" src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"></a-asset-item>
    </a-assets>

    <a-camera></a-camera>
    
    <a-light type="ambient" color="#888"></a-light>
    <a-light type="directional" intensity="0.5" position="-1 1 2"></a-light>

    <a-entity id="reticle" 
      geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02" 
      material="color: #007bff; shader: flat"
      visible="false">
    </a-entity>

    <a-entity id="placed-model" 
      gltf-model="#model" 
      scale="0.3 0.3 0.3" 
      visible="false">
    </a-entity>

  </a-scene>

  <script>
    // 取得 DOM Log 元素
    const logContainer = document.getElementById('dom-log');
    const sceneEl = document.querySelector('a-scene');
    const arButton = document.getElementById('ar-button');
    const reticle = document.getElementById('reticle');
    const placedModel = document.getElementById('placed-model');
    let hitTestSource = null;
    let modelPlaced = false;

    // Log 函式
    function logToDom(message) {
      console.log(message); // 同時在瀏覽器開發者工具中輸出
      logContainer.innerHTML += message + '<br>';
      logContainer.scrollTop = logContainer.scrollHeight; // 自動滾動到底部
    }

    logToDom('頁面載入完成，等待 A-Frame 初始化。');

    // 當 A-Frame 場景完全載入後
    sceneEl.addEventListener('loaded', () => {
        logToDom('A-Frame 場景已載入。');
        
        // 檢查瀏覽器是否支援 WebXR
        if (navigator.xr) {
            logToDom('瀏覽器支援 WebXR。');
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    logToDom('裝置支援 AR 模式。');
                    arButton.style.display = 'block';
                    arButton.addEventListener('click', () => {
                        logToDom('使用者點擊 "Enter AR" 按鈕。');
                    });
                } else {
                    logToDom('裝置不支援 AR 模式。');
                }
            });
        } else {
            logToDom('瀏覽器不支援 WebXR API。');
        }
    });

    // 當進入 AR 模式時
    sceneEl.addEventListener('enter-vr', () => {
        logToDom('成功進入 AR 模式。');
        const session = sceneEl.xrSession;
        
        // 要求一個 hit-test source，這是偵測真實世界平面的基礎
        session.requestReferenceSpace('viewer').then((referenceSpace) => {
            session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                hitTestSource = source;
                logToDom('成功獲取 Hit-Test Source，平面偵測已啟用。');
            });
        });

        // 監聽使用者點擊螢幕事件
        session.addEventListener('select', onSelect);
    });
    
    // 當離開 AR 模式時
    sceneEl.addEventListener('exit-vr', () => {
        logToDom('已離開 AR 模式。');
        if (hitTestSource) hitTestSource.cancel();
        hitTestSource = null;
    });

    // 每一幀渲染前執行的函式
    function onXRFrame(time, frame) {
        if (!hitTestSource) return;

        const hitTestResults = frame.getHitTestResults(hitTestSource);
        
        if (hitTestResults.length > 0) {
            // 偵測到平面
            reticle.setAttribute('visible', true);
            const hitPose = hitTestResults[0].getPose(sceneEl.xrSession.renderState.baseLayer.getViewport(frame.getViewerPose(sceneEl.xrSession.renderState.baseLayer.getViewport(frame.views[0]))).referenceSpace);

            reticle.object3D.position.copy(hitPose.transform.position);
            reticle.object3D.quaternion.copy(hitPose.transform.orientation);
            
        } else {
            // 沒有偵測到平面
            reticle.setAttribute('visible', false);
        }
    }

    // 處理螢幕點擊
    function onSelect(event) {
        logToDom('偵測到螢幕點擊 (select) 事件。');
        if (reticle.getAttribute('visible')) {
            if (modelPlaced) {
                logToDom('模型已存在，更新位置。');
            } else {
                logToDom('首次放置模型。');
                modelPlaced = true;
            }
            // 將模型放置在準星的位置
            placedModel.setAttribute('position', reticle.getAttribute('position'));
            placedModel.setAttribute('visible', true);
            logToDom(`模型已放置/更新於位置: ${JSON.stringify(reticle.getAttribute('position'))}`);
        } else {
            logToDom('點擊位置無效，未偵測到平面。');
        }
    }
    
    // 將 onXRFrame 註冊到 A-Frame 的渲染迴圈中
    sceneEl.addEventListener('renderstart', () => {
        sceneEl.xrSession.requestAnimationFrame(onXRFrame);
    });

  </script>
</body>
</html>