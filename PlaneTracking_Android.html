<!DOCTYPE html>
<html lang="en">

<head>
  <title>Android-AR</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <!-- 網頁用Console -->
  <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.0/vconsole.min.js"></script>
  <script>  var vConsole = new VConsole();  </script>
</head>

<body>
  </div>
  <!-- DOM區域 -->
  <!-- <div id="ButtonPanel">
    <div class="CustomBtn" id="start-ar2">
      <p id="Ani_text">啟動 AR 模式</p>
    </div>
    <div class="CustomBtn" id="Home_button">
      <p id="Home_text">返回主選單</p>
    </div>
  </div> -->

  <!-- <script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js",
					"three/addons/": "./jsm/"
				}
			}
		</script> -->

  <script type="module">

    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.118.3/build/three.module.js';
import { OBJLoader } from 'https://cdn.jsdelivr.net/npm/three@0.118.3/examples/jsm/loaders/OBJLoader.js';
import { MTLLoader } from 'https://cdn.jsdelivr.net/npm/three@0.118.3/examples/jsm/loaders/MTLLoader.js';

var container;
var camera, scene, renderer;
var controller;

var reticle;

var hitTestSource = null;
var hitTestSourceRequested = false;

var mtlLoader;
var monkeymesh;

init();
animate();

function init() {

	container = document.createElement( 'div' );
	document.body.appendChild( container );

	scene = new THREE.Scene();

	camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.01, 20 );
	camera.position.z = 10;

	var light = new THREE.HemisphereLight( 0xffffff, 0xbbbbff, 1 );
	light.position.set( 0.5, 1, 0.25 );
	scene.add( light );

	//

	renderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );
	renderer.setPixelRatio( window.devicePixelRatio );
	renderer.setSize( window.innerWidth, window.innerHeight );
	renderer.xr.enabled = true;
	container.appendChild( renderer.domElement );


	////////////////////////////////////////////////////////////////////////////////////////////////
	mtlLoader = new MTLLoader();
	mtlLoader.setPath( "./models/obj/monkey/" );
	mtlLoader.load( 'materials.mtl', function ( materials ) {

		materials.preload();

		var objLoader = new OBJLoader();
		objLoader.setMaterials( materials );
		objLoader.setPath( "./models/obj/monkey/" );
		objLoader.load( 'model.obj', function ( object ) {

			monkeymesh = object;
			scene.add( monkeymesh );

		} );

	} );

	var boxgeometry = new THREE.BoxBufferGeometry( 0.25, 0.25, 0.25 ).translate( 0, 0.1, 0 );

	function onSelect() {

		if ( reticle.visible ) {

			var material = new THREE.MeshPhongMaterial( { color: 0xffffff * Math.random() } );
			var mesh = new THREE.Mesh( boxgeometry, material );
			mesh.position.setFromMatrixPosition( reticle.matrix );
			//mesh.scale.y = Math.random() * 2 + 1;
			mesh.scale.set( 0.25, 0.25, 0.25 );
			scene.add( mesh );


		}

	}

	controller = renderer.xr.getController( 0 );
	controller.addEventListener( 'select', onSelect );
	scene.add( controller );

	reticle = new THREE.Mesh(
		new THREE.RingBufferGeometry( 0.15, 0.2, 32 ).rotateX( - Math.PI / 2 ),
		new THREE.MeshBasicMaterial()
	);
	reticle.matrixAutoUpdate = false;
	reticle.visible = false;
	scene.add( reticle );

	//

	window.addEventListener( 'resize', onWindowResize, false );

}


function onWindowResize() {

	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();

	renderer.setSize( window.innerWidth, window.innerHeight );

}

//

function animate() {

	renderer.setAnimationLoop( render );

}

function render( timestamp, frame ) {

	if ( frame ) {

		var referenceSpace = renderer.xr.getReferenceSpace();
		var session = renderer.xr.getSession();

		if ( hitTestSourceRequested === false ) {

			session.requestReferenceSpace( 'viewer' ).then( function ( referenceSpace ) {

				session.requestHitTestSource( { space: referenceSpace } ).then( function ( source ) {

					hitTestSource = source;

				} );

			} );

			session.addEventListener( 'end', function () {

				hitTestSourceRequested = false;
				hitTestSource = null;

			} );

			hitTestSourceRequested = true;

		}

		if ( hitTestSource ) {

			var hitTestResults = frame.getHitTestResults( hitTestSource );

			if ( hitTestResults.length ) {

				var hit = hitTestResults[ 0 ];

				reticle.visible = true;
				reticle.matrix.fromArray( hit.getPose( referenceSpace ).transform.matrix );

			} else {

				reticle.visible = false;

			}

		}

	}

	renderer.render( scene, camera );

}

  </script>
  <!-- <script src="src\js\PlaneTrackindMode.js"> </script> -->

  <!-- <script>
    document.getElementById('start-ar2').addEventListener('click', async () => {
      if (navigator.xr) {
        const session = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['hit-test']
        });

        renderer.xr.setSession(session);
      } else {
        alert('你的裝置不支援 WebXR AR 模式，啟用QuickLook');
      }
    });
  </script> -->

</body>

</html>